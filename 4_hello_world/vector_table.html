<!DOCTYPE HTML>
<html lang="ja" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>メモリ上の配置 - Haribote Embedded OS Rust Book</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">はじめに</a></li><li class="chapter-item expanded "><a href="../1_intro/embedded_os.html"><strong aria-hidden="true">1.</strong> 組み込みOSとは</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../1_intro/haribote_embedded_os.html"><strong aria-hidden="true">1.1.</strong> 本書で作る組み込みOS</a></li></ol></li><li class="chapter-item expanded "><a href="../2_setup/setup.html"><strong aria-hidden="true">2.</strong> 開発環境の構築</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../2_setup/rust.html"><strong aria-hidden="true">2.1.</strong> Rustのインストール</a></li><li class="chapter-item expanded "><a href="../2_setup/gdb.html"><strong aria-hidden="true">2.2.</strong> GDBのインストール</a></li><li class="chapter-item expanded "><a href="../2_setup/openocd.html"><strong aria-hidden="true">2.3.</strong> OpenOCDのインストール</a></li></ol></li><li class="chapter-item expanded "><a href="../3_rtfm/rtfm.html"><strong aria-hidden="true">3.</strong> RTFM</a></li><li class="chapter-item expanded "><a href="../4_hello_world/hello_world.html"><strong aria-hidden="true">4.</strong> Hello, world!</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../4_hello_world/boot.html"><strong aria-hidden="true">4.1.</strong> プログラムの実行</a></li><li class="chapter-item expanded "><a href="../4_hello_world/vector_table.html" class="active"><strong aria-hidden="true">4.2.</strong> メモリ上の配置</a></li><li class="chapter-item expanded "><a href="../4_hello_world/run_hello_world.html"><strong aria-hidden="true">4.3.</strong> Hello, world!</a></li><li class="chapter-item expanded "><a href="../4_hello_world/command.html"><strong aria-hidden="true">4.4.</strong> コマンドの省略</a></li></ol></li><li class="chapter-item expanded "><a href="../5_kernel_and_user/kernel_and_user.html"><strong aria-hidden="true">5.</strong> カーネルとユーザ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../5_kernel_and_user/svcall.html"><strong aria-hidden="true">5.1.</strong> SVCall（システムコール）</a></li><li class="chapter-item expanded "><a href="../5_kernel_and_user/task_switch.html"><strong aria-hidden="true">5.2.</strong> タスク切り替えの実装</a></li></ol></li><li class="chapter-item expanded "><a href="../6_scheduler/scheduler.html"><strong aria-hidden="true">6.</strong> スケジューラの実装</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../6_scheduler/non-preemptive_multitasking.html"><strong aria-hidden="true">6.1.</strong> ノンプリエンプティブ・マルチタスク</a></li></ol></li><li class="chapter-item expanded "><a href="../7_timer_interrupt/timer_interrupt.html"><strong aria-hidden="true">7.</strong> タイマ割り込み（SysTick例外）</a></li><li class="chapter-item expanded "><a href="../8_preemptive_multitasking/preemptive_multitasking.html"><strong aria-hidden="true">8.</strong> プリエンプティブ・マルチタスク</a></li><li class="chapter-item expanded "><a href="../9_gpio_peripheral/gpio_peripheral.html"><strong aria-hidden="true">9.</strong> GPIOペリフェラル</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../references.html">参考文献</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Haribote Embedded OS Rust Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#メモリ上の配置" id="メモリ上の配置">メモリ上の配置</a></h1>
<p>まずは，前回の章の内容を忘れないうちに，ベクタテーブルをメモリ上の正しい位置に配置する必要があります．そこで登場するのが，リンカスクリプトです．</p>
<p>プロジェクトのルートディレクトリに，<code>link.ld</code>というファイルを作成します．</p>
<pre><code class="language-shell">$ touch link.ld
</code></pre>
<h2><a class="header" href="#リンカスクリプト" id="リンカスクリプト">リンカスクリプト</a></h2>
<p>リンカスクリプトの書き方についての説明はあまりしませんが，そんなに難しくないので，やってることがわかれば大丈夫です．説明よりも先に見た方がいいと思うので，先にスクリプトを載せて，後から説明をしていくという方式にします．以下の内容を，<code>link.ld</code>に書き込みます．</p>
<pre><code>MEMORY
{
  FLASH : ORIGIN = 0x08000000, LENGTH = 256K
  RAM : ORIGIN = 0x20000000, LENGTH = 40K
}

ENTRY(Reset);

SECTIONS
{
  .vectors ORIGIN(FLASH) :
  {
    LONG(ORIGIN(RAM) + LENGTH(RAM));

    KEEP(*(.vectors.exceptions));
  } &gt; FLASH

  .text :
  {
    *(.text .text.*);
  } &gt; FLASH

  .rodata :
  {
    *(.rodata .rodata.*);
  } &gt; FLASH

  .bss (NOLOAD):
  {
    _sbss = .;
    *(.bss .bss.*);
    _ebss = .;
  } &gt; RAM

  .data : AT(ADDR(.rodata) + SIZEOF(.rodata))
  {
    _sdata = .;
    *(.data .data.*);
    _edata = .;
  } &gt; RAM

  _sidata = LOADADDR(.data);

  /DISCARD/ :
  {
    *(.ARM.exidx .ARM.exidx.*);
  }
}

PROVIDE(NMI = DefaultExceptionHandler);
PROVIDE(HardFault = DefaultExceptionHandler);
PROVIDE(MemManage = DefaultExceptionHandler);
PROVIDE(BusFault = DefaultExceptionHandler);
PROVIDE(UsageFault = DefaultExceptionHandler);
PROVIDE(SVCall = DefaultExceptionHandler);
PROVIDE(PendSV = DefaultExceptionHandler);
PROVIDE(SysTick = DefaultExceptionHandler);
</code></pre>
<p>順番に見ていきましょう．</p>
<h3><a class="header" href="#memory" id="memory">MEMORY</a></h3>
<p>最初にMEMORYブロックです．ここでは，メモリ空間の定義を行なっています．</p>
<p>一般に，マイコンのメモリは2種類のメモリから構成されています．1つはROM，もう1つはRAMです．</p>
<h4><a class="header" href="#rom" id="rom">ROM</a></h4>
<p>ROM（Read Only Memory）は，電源を切ってもデータが消えない読み出し専用のメモリです．主に、電源投入時，リセット時に実行するプログラムや，プログラム実行中に変化しない定数を保存します．マイコンでは，多くの場合，フラッシュメモリをROMとして搭載しています．</p>
<h4><a class="header" href="#ram" id="ram">RAM</a></h4>
<p>RAM（Random Access Memory）は，データの読み書きは自由に行えるが，電源を切ると内容が消えるメモリです．主に，実行中のプログラムの変数を保存します．</p>
<p>これら2つのメモリを用いて，プログラムを動かすので，私たちは，コンパイラにこれらのメモリのアドレスを教える必要があります．</p>
<p><a href="https://www.st.com/resource/en/datasheet/stm32f303vc.pdf">Datasheet</a>の<code>5 Memory mapping</code>を見ると，FLASHの領域は<code>0x0800_0000</code>から始まっていることがわかります．また，<code>3.3 Embedded Flash memory</code>によると，サイズは<code>256 Kbytes</code>であることがわかります．</p>
<p>RAMも同様です．<code>5 Memory mapping</code>を見ると，FLASHの領域は<code>0x2000_0000</code>から始まっていることがわかります．<code>3.3 Embedded Flash memory</code>によると，サイズは<code>40 Kbytes</code>であることがわかります．</p>
<pre><code>MEMORY
{
  FLASH : ORIGIN = 0x08000000, LENGTH = 256K
  RAM : ORIGIN = 0x20000000, LENGTH = 40K
}
</code></pre>
<h3><a class="header" href="#entry" id="entry">ENTRY</a></h3>
<p>エントリーポイントの定義を行います．コンパイラに，エントリーポイントの場所を教えます．まだコードを書いてないのですが，<code>Reset</code>という関数をエントリーポイントとします．このエントリーポイントは，ベクタテーブルの<code>Reset</code>ベクタとしても使います．</p>
<pre><code>ENTRY(Reset);
</code></pre>
<h3><a class="header" href="#sections" id="sections">SECTIONS</a></h3>
<p>SECTIONSでは，プログラムを作成する際に配置の基準となる，セクションと呼ばれる単位が，実際メモリのどこに置かれるのかを記述します．主に次のような感じになっています．</p>
<pre><code>SECTIONS {
    セクション名 : {} &gt; メモリ領域名
    コマンド
    ...
}
</code></pre>
<p>セクション名の中には，用途が決まっている物がいくつかあるので，それを表で示します．</p>
<table><thead><tr><th align="center">セクション名</th><th align="center">説明</th></tr></thead><tbody>
<tr><td align="center">.vectors</td><td align="center">割り込みベクタが配置されます．</td></tr>
<tr><td align="center">.text</td><td align="center">プログラムのコード（関数）が配置されます．</td></tr>
<tr><td align="center">.rodata</td><td align="center">読み出し専用のデータ（プログラムの定数）が配置されます．</td></tr>
<tr><td align="center">.bss</td><td align="center">初期値を持たない静的変数などが配置されます．</td></tr>
<tr><td align="center">.data</td><td align="center">初期値を持つ静的変数などが配置されます．</td></tr>
</tbody></table>
<p>順番に見ていきましょう．</p>
<p>FLASHに配置するセクションは，<code>.vectors</code>，<code>.text</code>，<code>.rodata</code>の3つです．</p>
<p><code>.vectors</code>は，前章で詳しく説明した<code>Vector Table</code>が配置される場所です．</p>
<p>最初のエントリが何か覚えていますか？<code>SP_main</code>の初期値でしたね．前章でスタックには積み上がっていくというような表現をしましたが，CortexーM4では，正確には積み下がっていきます．難しい話ではないです．スタックにデータを積む際に，アドレスが減る方向に積まれていくということです．なので，<code>SP_main</code>の初期値には，RAMの末尾のアドレスを指定します．</p>
<p>あとは例外ハンドラのエントリーが続くので，そこを<code>.vectors.exceptions</code>とします．中身はあとでコードの方に書きます．</p>
<p>というわけで，FLASHに配置する3つのセクションはこのようになります．</p>
<pre><code>  .vectors ORIGIN(FLASH) :
  {
    LONG(ORIGIN(RAM) + LENGTH(RAM));

    KEEP(*(.vectors.exceptions));
  } &gt; FLASH

  .text :
  {
    *(.text .text.*);
  } &gt; FLASH

  .rodata :
  {
    *(.rodata .rodata.*);
  } &gt; FLASH
</code></pre>
<p>RAMに配置されるセクションは，<code>.bss</code>，<code>.data</code>の2つです．これら2つの領域は，プログラム中で値を書き換える必要があるので，RAMに配置する必要があります．プログラムからアドレスを参照できるように，ロケーションカウンタ（<code>.</code>）というのを使います．</p>
<pre><code>  .bss (NOLOAD):
  {
    _sbss = .;
    *(.bss .bss.*);
    _ebss = .;
  } &gt; RAM

  .data : AT(ADDR(.rodata) + SIZEOF(.rodata))
  {
    _sdata = .;
    *(.data .data.*);
    _edata = .;
  } &gt; RAM
</code></pre>
<p>ロケーションカウンタに値を代入してるので，<code>_sbss</code>は<code>.bss</code>セクションの先頭アドレス，<code>_ebss</code>は<code>.bss</code>セクションの末尾アドレス，<code>_sdata</code>は<code>.data</code>セクションの先頭アドレス，<code>_edata</code>は<code>.data</code>セクションの末尾アドレスを指します．</p>
<p>SECTIONSブロックの最後の部分について説明します．</p>
<p><code>_sidata</code>には<code>.data</code>の，FLASH上での配置アドレスを代入します．
<code>.data</code>の初期値は，<code>.rodata</code>セクションにあり，<code>.rodata</code>セクションはFLASH上にあります．</p>
<p><code>/DISCARD/</code>のブロックでは，<code>.ARM.exidx</code>は標準ライブラリでのみ利用するので，破棄しています．</p>
<pre><code>  _sidata = LOADADDR(.data);

  /DISCARD/ :
  {
    *(.ARM.exidx .ARM.exidx.*);
  }
</code></pre>
<h3><a class="header" href="#provide" id="provide">PROVIDE</a></h3>
<p>リンカスクリプトの最後の部分です．<code>PROVIDE</code>は，弱結合シンボルと呼ばれるシンボルを生成します．該当する関数が見つからなかった場合は，これを代わりに使うということを指示します．</p>
<pre><code>PROVIDE(NMI = DefaultExceptionHandler);
PROVIDE(HardFault = DefaultExceptionHandler);
PROVIDE(MemManage = DefaultExceptionHandler);
PROVIDE(BusFault = DefaultExceptionHandler);
PROVIDE(UsageFault = DefaultExceptionHandler);
PROVIDE(SVCall = DefaultExceptionHandler);
PROVIDE(PendSV = DefaultExceptionHandler);
PROVIDE(SysTick = DefaultExceptionHandler);
</code></pre>
<p>なんだか見たことある名前たちですね．これらは全て<code>Vector Table</code>で見た例外ハンドラです．それぞれの例外時の挙動を別々に定義すると大変ですから，該当する例外ハンドラの定義がなければ<code>DefaultExceptionHandler</code>という関数を共通して使いましょうっていう意味です．</p>
<p>2章連続でかなり長い内容になってしまいました．準備は整ったので，ついに次章で<code>Hello, world!</code>します！</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../4_hello_world/boot.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../4_hello_world/run_hello_world.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../4_hello_world/boot.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../4_hello_world/run_hello_world.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
